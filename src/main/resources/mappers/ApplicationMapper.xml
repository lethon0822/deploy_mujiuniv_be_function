<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.muziuniv_be_notuser.app.shared.application.ApplicationMapper">

    <!-- 다음 학기 id 조회 -->
    <select id="selectNextSemesterId">
        SELECT s2.semester_id
        FROM semester s2
        WHERE (s2.year, s2.semester) >
        (SELECT s.year, s.semester FROM semester s WHERE s.semester_id = #{currentSemesterId})
        ORDER BY s2.year, s2.semester
        LIMIT 1
    </select>

    <!-- 현재 시각이 일정 창 안인지 -->
    <select id="isScheduleOpenNow">
        SELECT CASE WHEN NOW() BETWEEN sc.start_datetime AND sc.end_datetime THEN 1 ELSE 0 END
        FROM schedule sc
        WHERE sc.schedule_id = #{scheduleId}
    </select>

    <!-- 특정 학생이 같은 학기+유형으로 이미 신청했는지 확인 -->
    <select id="existsActiveApplication">
        SELECT COUNT(*)
        FROM application a
        JOIN schedule s ON a.schedule_id = s.schedule_id
        WHERE a.user_id = #{userId}
        AND s.semester_id = #{semesterId}
        AND s.schedule_type = #{scheduleType}
        AND a.status = '처리중'
    </select>

    <!-- 내 신청목록 -->
    <select id="selectMyApplications">
        SELECT
        a.app_id          AS appId,
        a.status,
        a.reason,
        a.created_at      AS submittedAt,
        sc.schedule_type  AS scheduleType,
        sc.start_datetime AS scheduleStart,
        sc.end_datetime   AS scheduleEnd,
        sem.year          AS year,
        sem.semester      AS semester
        FROM application a
        JOIN schedule sc   ON sc.schedule_id  = a.schedule_id
        JOIN semester sem  ON sem.semester_id = sc.semester_id
        WHERE a.user_id = #{userId}
        ORDER BY a.created_at DESC
    </select>

    <!-- 처리중 → 취소 -->
    <update id="cancelIfPending">
        UPDATE application
        SET status = '취소'
        WHERE app_id = #{appId}
        AND user_id = #{userId}
        AND status = '처리중'
    </update>

    <!-- scheduleId로 학기 조회 -->
    <select id="findSemesterIdByScheduleId">
        SELECT semester_id
        FROM schedule
        WHERE schedule_id = #{scheduleId}
    </select>

    <!-- scheduleId로 유형 조회 -->
    <select id="findScheduleTypeByScheduleId">
        SELECT schedule_type
        FROM schedule
        WHERE schedule_id = #{scheduleId}
    </select>

    <!-- 신청 INSERT -->
    <insert id="insertApplication">
        INSERT INTO application (user_id, schedule_id, status, reason, created_at)
        VALUES (#{userId}, #{scheduleId}, '처리중', #{reason}, NOW())
    </insert>

</mapper>
